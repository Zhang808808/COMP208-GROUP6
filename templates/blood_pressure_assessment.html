{% extends "base.html" %}

{% block content %}
<div class="container-fluid">
    <h1 class="mb-4">Blood Pressure Assessment</h1>

    <!-- Assessment Form -->
    <div class="card mb-4 shadow" id="assessmentForm">
        <div class="card-header bg-primary text-white">
            <h5 class="card-title mb-0"><i class="fas fa-clipboard-check"></i> Assessment Form</h5>
        </div>
        <div class="card-body">
            <form id="bpAssessmentForm">
                <!-- Personal Information -->
                <div class="mb-4">
                    <h6 class="text-primary"><i class="fas fa-user-circle"></i> Personal Information</h6>
                    <div class="row g-3">
                        <div class="col-md-6">
                            <label for="age" class="form-label">Age (years)</label>
                            <input type="number" class="form-control" id="age" name="age" min="18" max="120" required>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Gender</label>
                            <div>
                                <div class="form-check">
                                    <input class="form-check-input" type="radio" name="male" id="male_yes" value="1" required>
                                    <label class="form-check-label" for="male_yes">Male</label>
                                </div>
                                <div class="form-check">
                                    <input class="form-check-input" type="radio" name="male" id="male_no" value="0" required>
                                    <label class="form-check-label" for="male_no">Female</label>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Health Status -->
                <div class="mb-4">
                    <h6 class="text-primary"><i class="fas fa-heart"></i> Health Status</h6>
                    <div class="row g-3">
                        <div class="col-md-6">
                            <label class="form-label">Current Smoker</label>
                            <div>
                                <div class="form-check">
                                    <input class="form-check-input" type="radio" name="currentSmoker" id="smoker_yes" value="1" required>
                                    <label class="form-check-label" for="smoker_yes">Yes</label>
                                </div>
                                <div class="form-check">
                                    <input class="form-check-input" type="radio" name="currentSmoker" id="smoker_no" value="0" required>
                                    <label class="form-check-label" for="smoker_no">No</label>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6" id="cigsPerDayField" style="display:none;">
                            <label for="cigsPerDay" class="form-label">Cigarettes Per Day</label>
                            <input type="number" class="form-control" id="cigsPerDay" name="cigsPerDay" min="0" max="100">
                        </div>
                    </div>
                    <div class="row g-3 mt-2">
                        <div class="col-md-6">
                            <label class="form-label">On Blood Pressure Medication</label>
                            <div>
                                <div class="form-check">
                                    <input class="form-check-input" type="radio" name="BPMeds" id="bpmeds_yes" value="1" required>
                                    <label class="form-check-label" for="bpmeds_yes">Yes</label>
                                </div>
                                <div class="form-check">
                                    <input class="form-check-input" type="radio" name="BPMeds" id="bpmeds_no" value="0" required>
                                    <label class="form-check-label" for="bpmeds_no">No</label>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Diabetes</label>
                            <div>
                                <div class="form-check">
                                    <input class="form-check-input" type="radio" name="diabetes" id="diabetes_yes" value="1" required>
                                    <label class="form-check-label" for="diabetes_yes">Yes</label>
                                </div>
                                <div class="form-check">
                                    <input class="form-check-input" type="radio" name="diabetes" id="diabetes_no" value="0" required>
                                    <label class="form-check-label" for="diabetes_no">No</label>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Medical Measurements -->
                <div class="mb-4">
                    <h6 class="text-primary"><i class="fas fa-heartbeat"></i> Medical Measurements</h6>
                    <div class="row g-3">
                        <div class="col-md-4">
                            <label for="sysBP" class="form-label">Systolic BP (mmHg)</label>
                            <input type="number" class="form-control" id="sysBP" name="sysBP" min="70" max="250" required>
                        </div>
                        <div class="col-md-4">
                            <label for="diaBP" class="form-label">Diastolic BP (mmHg)</label>
                            <input type="number" class="form-control" id="diaBP" name="diaBP" min="40" max="150" required>
                        </div>
                        <div class="col-md-4">
                            <label for="heartRate" class="form-label">Heart Rate (bpm)</label>
                            <input type="number" class="form-control" id="heartRate" name="heartRate" min="40" max="200" required>
                        </div>
                    </div>
                    <div class="row g-3 mt-2">
                        <div class="col-md-4">
                            <label for="totChol" class="form-label">Total Cholesterol (mg/dL)</label>
                            <input type="number" class="form-control" id="totChol" name="totChol" min="100" max="600" required>
                        </div>
                        <div class="col-md-4">
                            <label for="BMI" class="form-label">BMI (kg/mÂ²)</label>
                            <input type="number" class="form-control" id="BMI" name="BMI" min="15" max="50" step="0.1" required>
                        </div>
                        <div class="col-md-4">
                            <label for="glucose" class="form-label">Glucose (mg/dL)</label>
                            <input type="number" class="form-control" id="glucose" name="glucose" min="50" max="400" required>
                        </div>
                    </div>
                </div>

                <!-- Submit Button -->
                <div class="text-center">
                    <button type="submit" class="btn btn-primary btn-lg">
                        <i class="fas fa-paper-plane"></i> Submit Assessment
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Results Container (initially hidden) -->
    <div class="card mb-4 shadow d-none" id="resultsContainer">
        <div class="card-header bg-success text-white">
            <h5 class="card-title mb-0"><i class="fas fa-check-circle"></i> Assessment Results</h5>
        </div>
        <div class="card-body">
            <div id="assessmentResult"></div>
            <div class="text-center mt-4">
                <a href="/health_tips" class="btn btn-primary">
                    <i class="fas fa-lightbulb"></i> View Health Tips
                </a>
                <button id="newAssessmentBtn" class="btn btn-outline-primary ms-2">
                    <i class="fas fa-redo"></i> New Assessment
                </button>
            </div>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const form = document.getElementById('bpAssessmentForm');
    const assessmentForm = document.getElementById('assessmentForm');
    const resultsContainer = document.getElementById('resultsContainer');
    const resultDiv = document.getElementById('assessmentResult');
    const newAssessmentBtn = document.getElementById('newAssessmentBtn');
    const cigsPerDayField = document.getElementById('cigsPerDayField');

    // Show/hide cigarettes field based on smoker status
    document.querySelectorAll('input[name="currentSmoker"]').forEach(radio => {
        radio.addEventListener('change', function() {
            cigsPerDayField.style.display = this.value === '1' ? 'block' : 'none';
            if (this.value === '0') {
                document.getElementById('cigsPerDay').value = '';
            }
        });
    });

    // Handle form submission
    form.addEventListener('submit', function(e) {
        e.preventDefault();
        
        // Show loading state
        const submitBtn = form.querySelector('button[type="submit"]');
        submitBtn.disabled = true;
        submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Processing...';

        // Collect form data
        const formData = new FormData(form);
        const jsonData = {};
        formData.forEach((value, key) => {
            jsonData[key] = value;
        });

        // AJAX request
        fetch('/assess_blood_pressure', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(jsonData)
        })
        .then(response => {
            if (!response.ok) {
                throw new Error('Network response was not ok');
            }
            return response.json();
        })
        .then(data => {
            if (data.status === 'error') {
                showError(data.message);
            } else {
                showResults(data);
            }
        })
        .catch(error => {
            showError('An error occurred while processing your request: ' + error.message);
        })
        .finally(() => {
            submitBtn.disabled = false;
            submitBtn.innerHTML = '<i class="fas fa-paper-plane"></i> Submit Assessment';
        });
    });

    // Show results function
    function showResults(data) {
        // Hide form, show results
        assessmentForm.classList.add('d-none');
        resultsContainer.classList.remove('d-none');
        
        // Set main result
        resultDiv.className = `alert alert-${data.status}`;
        resultDiv.innerHTML = `
            <h4 class="mb-3">${data.message}</h4>
            <p class="mb-0">Your risk score: ${data.details.risk_score}</p>
        `;
        
        // Scroll to results
        resultsContainer.scrollIntoView({ behavior: 'smooth' });
    }

    // Show error function
    function showError(message) {
        // Remove any existing error alerts
        document.querySelectorAll('.alert-danger').forEach(el => el.remove());
        
        const alertDiv = document.createElement('div');
        alertDiv.className = 'alert alert-danger mb-3';
        alertDiv.innerHTML = `<i class="fas fa-exclamation-circle"></i> ${message}`;
        form.prepend(alertDiv);
        
        // Remove alert after 5 seconds
        setTimeout(() => {
            alertDiv.remove();
        }, 5000);
    }

    // New assessment button
    newAssessmentBtn.addEventListener('click', function() {
        resultsContainer.classList.add('d-none');
        assessmentForm.classList.remove('d-none');
        form.reset();
        window.scrollTo({ top: 0, behavior: 'smooth' });
    });
});
</script>

<style>
    /* Animation for results */
    #resultsContainer {
        animation: fadeIn 0.5s ease-out;
    }
    
    @keyframes fadeIn {
        from { opacity: 0; transform: translateY(20px); }
        to { opacity: 1; transform: translateY(0); }
    }
    
    /* Loading spinner */
    .fa-spinner {
        margin-right: 8px;
    }
    
    /* Form styling */
    .form-label {
        font-weight: 500;
    }
    
    .form-control {
        border-radius: 8px;
        padding: 10px 15px;
    }
    
    /* Card styling */
    .card {
        border-radius: 10px;
    }
    
    .card-header {
        border-radius: 10px 10px 0 0 !important;
    }
</style>
{% endblock %}